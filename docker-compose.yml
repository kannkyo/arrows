version: "3.6"

services:
  nginx:
    image: nginx:1.17.4
    restart: unless-stopped
    env_file:
      - ./common/common.env
    volumes:
      - ./nginx/mysite.template:/etc/nginx/conf.d/mysite.template:ro
    ports:
      - "80:80"
      - "443:443"
    command: /bin/bash -c "envsubst '' < /etc/nginx/conf.d/mysite.template > /etc/nginx/conf.d/default.conf && exec nginx -g 'daemon off;'"
    depends_on:
      - gitlab
      - jenkins
      - nexus
      - plantuml
      - redmine
    networks:
      - public

  gitlab:
    image: gitlab/gitlab-ce:12.3.5-ce.0
    restart: unless-stopped
    env_file:
      - ./common/common.env
    environment:
      GITLAB_OMNIBUS_CONFIG: "from_file('/omnibus_config.rb')"
    volumes:
      - gitlab-data:/var/opt/gitlab
      - gitlab-etc:/etc/gitlab
      - gitlab-logs:/var/log/gitlab
      - redmine-git:/var/redmine/git_repositories
      - ./gitlab/ce/omnibus_config.rb:/omnibus_config.rb:ro
    depends_on:
      - plantuml
    networks:
      - public
      - gitlab-nw

  plantuml:
    image: plantuml/plantuml-server:jetty
    restart: unless-stopped
    env_file:
      - ./common/common.env
    volumes:
      - ./gitlab/plantuml/ROOT.xml:/var/lib/jetty/webapps/ROOT.xml:ro
    networks:
      - public
      - gitlab-nw

  redmine:
    build: ./redmine/app
    restart: unless-stopped
    env_file:
      - ./common/common.env
      - ./redmine/app/default.env
    volumes:
      - gitlab-data:/var/opt/gitlab
      - redmine-files:/usr/src/redmine/files
      - redmine-git:/var/redmine/git_repositories #for gitlab
      - ./redmine/app/config.ru:/usr/src/redmine/config.ru:ro #for nginx
    depends_on:
      - redmine-db
    networks:
      - public
      - redmine-nw

  redmine-db:
    image: mysql:5.7
    restart: unless-stopped
    env_file:
      - ./common/common.env
      - ./redmine/db/default.env
    volumes:
      - redmine-db-data:/var/lib/mysql
      - ./redmine/db/charset.cnf:/etc/mysql/conf.d/charset.cnf:ro #for japanese
    networks:
      - redmine-nw

  nexus:
    image: sonatype/nexus3:3.19.0
    restart: unless-stopped
    env_file:
      - ./common/common.env
      - ./nexus/default.env
    ports:
      - "48082:48082" #docker proxy server
      - "48083:48083" #docker hosted server
    volumes:
      - nexus-data:/nexus-data
      - ./nexus/config/nexus.properties:/nexus-data/etc/nexus.properties:ro #for nginx
    networks:
      - public

  jenkins:
    image: jenkinsci/blueocean:latest
    restart: unless-stopped
    env_file:
      - ./common/common.env
      - ./jenkins/master/default.env
    volumes:
      - jenkins-home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock # for instantiate other Docker containers
    ports:
      - "50000:50000"
    networks:
      - public

networks:
  public:
  gitlab-nw:
  redmine-nw:

volumes:
  gitlab-data:
  gitlab-etc:
  gitlab-logs:
  jenkins-home:
  nexus-data:
  redmine-db-data:
  redmine-files:
  redmine-git:
