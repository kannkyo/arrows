version: "3.6"

services:
  ntp:
    image: cturra/ntp:latest
    env_file:
      - ./common/common.env
    restart: always
    ports:
      - "123:123"
    networks:
      - public

  nginx:
    image: nginx:1.17.4
    env_file:
      - ./common/common.env
    restart: always
    volumes:
      - ./nginx/config/mysite.template:/etc/nginx/conf.d/mysite.template:ro
    ports:
      - "80:80"
      - "443:443"
    command: /bin/bash -c "envsubst '' < /etc/nginx/conf.d/mysite.template > /etc/nginx/conf.d/default.conf && exec nginx -g 'daemon off;'"
    depends_on:
      - gitlab
      - jenkins
      - ntp
      - phpldapadmin
      - plantuml
      - redmine
      - rocketchat
    networks:
      - public

  openldap:
    image: osixia/openldap:1.2.2
    env_file:
      - ./common/common.env
      - ./ldap/openldap/default.env
    volumes:
      - ldap-config:/etc/ldap/slapd.d
      - ldap-data:/var/lib/ldap
    networks:
      - public

  phpldapadmin:
    image: osixia/phpldapadmin:0.7.2
    env_file:
      - ./common/common.env
      - ./ldap/phpldapadmin/default.env
    depends_on:
      - openldap
    networks:
      - public

  gitlab:
    image: gitlab/gitlab-ce:12.3.5-ce.0
    env_file:
      - ./common/common.env
    restart: always
    volumes:
      - gitlab-data:/var/opt/gitlab
      - gitlab-etc:/etc/gitlab
      - gitlab-logs:/var/log/gitlab
      - redmine-git:/var/redmine/git_repositories
      - ./gitlab/ce/omnibus_config.rb:/omnibus_config.rb:ro
    ports:
      - "10081:10081"
      - "10080:80"
      - "10082:10082"
      - "10443:443"
      - "10022:22"
    environment:
      GITLAB_OMNIBUS_CONFIG: "from_file('/omnibus_config.rb')"
    depends_on:
      - plantuml
    networks:
      - public
      - gitlab-nw

  plantuml:
    image: plantuml/plantuml-server:jetty
    env_file:
      - ./common/common.env
    restart: always
    ports:
      - "38080:8080"
    volumes:
      - ./gitlab/plantuml/ROOT.xml:/var/lib/jetty/webapps/ROOT.xml:ro
    networks:
      - public
      - gitlab-nw

  redmine:
    build: ./redmine/app
    env_file:
      - ./common/common.env
      - ./redmine/app/default.env
    restart: always
    ports:
      - "23000:3000"
    volumes:
      - gitlab-data:/var/opt/gitlab
      - redmine-files:/usr/src/redmine/files
      - redmine-git:/var/redmine/git_repositories #for gitlab
      - ./redmine/app/config/config.ru:/usr/src/redmine/config.ru:ro #for nginx
    depends_on:
      - redmine-db
    networks:
      - public
      - redmine-nw

  redmine-db:
    image: mysql:5.7
    env_file:
      - ./common/common.env
      - ./redmine/db/default.env
    restart: always
    volumes:
      - redmine-db-data:/var/lib/mysql
      - ./redmine/db/config/charset.cnf:/etc/mysql/conf.d/charset.cnf:ro #for japanese
    networks:
      - redmine-nw

  nexus:
    image: sonatype/nexus3:3.19.0
    env_file:
      - ./common/common.env
      - ./nexus/default.env
    restart: always
    ports:
      - "48081:8081" #others
      - "48082:48082" #docker proxy server
      - "48083:48083" #docker hosted server
    volumes:
      - nexus-data:/nexus-data
      - ./nexus/config/nexus.properties:/nexus-data/etc/nexus.properties:ro #for nginx
    networks:
      - public

  jenkins:
    image: kannkyo/jenkins:latest
    env_file:
      - ./common/common.env
      - ./jenkins/master/default.env
    restart: always
    volumes:
      - jenkins-home:/var/jenkins_home
    ports:
      - "58080:8080"
      - "50000:50000"
    networks:
      - public
      - jenkins-nw

  rocketchat:
    image: rocketchat/rocket.chat:latest
    env_file:
      - ./common/common.env
      - ./rocketchat/rocket.chat/default.env
    volumes:
      - rocketchat-uploads:/app/uploads
    depends_on:
      - rocketchat-db
    ports:
      - "3000:3000"
    networks:
      - public
      - rocket-nw

  rocketchat-db:
    image: mongo:latest
    env_file:
      - ./common/common.env
    command: mongod --smallfiles
    ports:
      - 27017
    volumes:
      - rocketchat-db-data:/data/db
      - rocketchat-db-dump:/dump
    networks:
      - rocket-nw

  hubot:
    image: rocketchat/hubot-rocketchat:latest
    restart: unless-stopped
    env_file:
      - ./common/common.env
      - ./rocketchat/hubot/default.env
    depends_on:
      - rocketchat
    ports:
      - "3001:8080"
    networks:
      - gitlab-nw
      - rocket-nw

  samba:
    build: ./samba
    env_file:
      - ./common/common.env
    volumes:
      - ./samba/smb.conf:/etc/samba/smb.conf:ro
      - samba-data:/share
    ports:
      - "445:445"
    networks:
      - public

configs:
  gitlab:
    file: ./gitlab/ce/config/omnibus_config.rb

secrets:
  gitlab_root_password:
    file: ./secrets/gitlab.txt

networks:
  public:
  gitlab-nw:
  jenkins-nw:
  redmine-nw:
  rocket-nw:

volumes:
  # archiva-data:
  gitlab-data:
  gitlab-etc:
  gitlab-logs:
  jenkins-home:
  ldap-config:
  ldap-data:
  nexus-backup:
  nexus-data:
  redmine-db-data:
  redmine-files:
  redmine-git:
  rocketchat-db-data:
  rocketchat-db-dump:
  rocketchat-uploads:
  samba-data:
