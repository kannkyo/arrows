version: '3.1'

services:
  ntp:
    build: ./ntp
    restart: always
    ports:
      - '123:123'
    networks:
      - public

  nginx:
    build: ./nginx
    restart: always
    volumes:
      - ./nginx/mysite.template:/etc/nginx/conf.d/mysite.template:ro
    ports:
      - '80:80'
      - '443:443'
    command: /bin/bash -c "envsubst '' < /etc/nginx/conf.d/mysite.template > /etc/nginx/conf.d/default.conf && exec nginx -g 'daemon off;'"
    depends_on:
      - archiva
      - gitlab
      - jenkins
      - ntp
      - redmine
    networks:
      - public

  gitlab:
    build: ./gitlab/ce
    restart: always
    volumes:
      - gitlab-etc:/etc/gitlab
      - gitlab-logs:/var/log/gitlab
      - gitlab-data:/var/opt/gitlab
      - ./gitlab/_backup:/secret/gitlab/backups
    ports:
      - '10081:10081'
      - '10080:80'
      - '10082:10082'
      - '10443:443'
      - '10022:22'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        gitlab_rails['lfs_enabled'] = true
        external_url 'http://localhost:80/gitlab'
        mattermost_external_url 'http://localhost:10081'
        registry_external_url 'http://localhost:10082'
    networks:
      - public
      - gitlab-nw

  gitlab-runner:
    build: ./gitlab/runner
    restart: always
    volumes:
      - gitlab-runner-etc:/etc/gitlab-runner
      - gitlab-runner-home:/home/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.soc:ro
    networks:
      - gitlab-nw

  gitlab-specific-runner:
    build: ./gitlab/runner
    restart: always
    volumes:
      - gitlab-specific-runner-etc:/etc/gitlab-runner
      - gitlab-specific-runner-home:/home/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.soc:ro
    networks:
      - gitlab-nw

  redmine:
    build: ./redmine/app
    restart: always
    ports:
      - '23000:3000'
    volumes:
      - redmine-files:/usr/src/redmine/files
      - ./redmine/config.ru:/usr/src/redmine/config.ru:ro #for nginx
    environment:
      REDMINE_DB_MYSQL: redmine-db
      REDMINE_DB_PASSWORD: example
      RAILS_RELATIVE_URL_ROOT: /redmine
    networks:
      - public
      - redmine-nw

  redmine-db:
    build: ./redmine/db
    restart: always
    volumes:
      - redmine-db-data:/var/lib/mysql
      - ./redmine/db/charset.cnf:/etc/mysql/conf.d/charset.cnf/:ro #for japanese
    environment:
      MYSQL_ROOT_PASSWORD: example
      MYSQL_DATABASE: redmine
    networks:
      - redmine-nw

  nexus:
    build: ./nexus
    restart: always
    ports:
      - '48081:8081'  #others
      - '48082:48082' #docker
    volumes:
      - nexus-data:/nexus-data
      - ./nexus/nexus.properties:/nexus-data/etc/nexus.properties:ro #for nginx
    environment:
      NEXUS_CONTEXT: nexus #for nginx
    networks:
      - public
 
  jenkins:
    build: ./jenkins/master
    restart: always
    volumes:
      - jenkins-home:/var/jenkins_home
    environment:
      JENKINS_OPTS: --prefix=/jenkins #for nginx
    ports:
      - '58080:8080'
      - '50000:50000'
    networks:
      - public
      - jenkins-nw

  archiva:
    image: xetusoss/archiva
    restart: always
    environment:
      TZ: Asia/Tokyo
    volumes:
      - archiva-data:/archiva-data
      - ./archiva/archiva.xml:/archiva/contexts/archiva.xml:ro #for nginx
    ports:
      - '1080:8080'
    networks:
      - public

  rocketchat:
    image: rocketchat/rocket.chat:latest
    restart: always
    environment:
      TZ: Asia/Tokyo
      MONGO_URL: mongodb://mongodb/rocketchat
      ROOT_URL: http://localhost/rocketchat
    ports:
      - "1235:3000"
    networks:
      - public
      - rocket-nw

  mongodb:
    image: mongo:latest
    restart: always
    environment:
      TZ: Asia/Tokyo
    ports:
      - 27017
    volumes:
      - rocketchat-db:/var/lib/mongodb
    networks:
      - rocket-nw

  hubot:
    image: rocketchat/hubot-rocketchat:latest
    restart: always
    environment:
      TZ: Asia/Tokyo
      ROCKETCHAT_URL: rocketchat:3000
      ROCKETCHAT_ROOM: GENERAL
      ROCKETCHAT_USER: bot
      ROCKETCHAT_PASSWORD: bot
      BOT_NAME: bot
      EXTERNAL_SCRIPTS: hubot-pugme,hubot-help
    networks:
      - rocket-nw

networks:
  public:
  redmine-nw:
  gitlab-nw:
  rocket-nw:
  jenkins-nw:

volumes:
  gitlab-etc:
  gitlab-logs:
  gitlab-data:
  gitlab-runner-etc:
  gitlab-runner-home:
  gitlab-specific-runner-etc:
  gitlab-specific-runner-home:
  redmine-files:
  redmine-db-data:
  nexus-data:
  jenkins-home:
  archiva-data:
  rocketchat-db:

